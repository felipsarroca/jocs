<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutifruti</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body, #root {
      height: 100%;
      width: 100%;
      margin: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      overflow-x: hidden;
      overflow-y: auto;
    }
    #root {
      display: flex;
      min-height: 100vh;
      min-width: 100vw;
    }
    .app-container {
      flex: 1 0 auto;
      min-height: 100vh;
      width: 100%;
    }
    @supports (height: 100dvh) {
      body {
        min-height: 100dvh;
      }
      #root,
      .app-container {
        min-height: 100dvh;
      }
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import { Play, Pause, RotateCcw, Moon, Sun } from 'https://esm.sh/lucide-react@0.309.0';

    const CATEGORIES = [
      { id: 'nom', name: 'Nom propi', jsonKey: 'Nom', icon: 'üßë', color: 'from-pink-400 to-pink-600' },
      { id: 'lloc', name: 'Pa√≠s', jsonKey: 'Pa√≠s', icon: 'üåç', color: 'from-blue-400 to-blue-600' },
      { id: 'animal', name: 'Animal', jsonKey: 'Animal', icon: 'üêæ', color: 'from-green-400 to-green-600' },
      { id: 'menjar', name: 'Menjar', jsonKey: 'Menjar', icon: 'üçé', color: 'from-red-400 to-red-600' },
      { id: 'objecte', name: 'Objecte', jsonKey: 'Objecte', icon: 'üõ†Ô∏è', color: 'from-purple-400 to-purple-600' },
      { id: 'color', name: 'Color', jsonKey: 'Color', icon: 'üé®', color: 'from-yellow-400 to-yellow-600' }
    ];

    const LETTERS = 'ABCDEFGHIJLMNOPRSTUVX'.split('');
    const GAME_TIME = 120; // 2 minuts en segons

    function TutifrutiGame({ wordRepository }) {
      const [darkMode, setDarkMode] = useState(false);
      const [gameState, setGameState] = useState('initial'); // initial, spinning, playing, paused, finished
      const [currentLetter, setCurrentLetter] = useState('');
      const [spinningLetter, setSpinningLetter] = useState('');
      const [timeLeft, setTimeLeft] = useState(GAME_TIME);
      const [suggestions, setSuggestions] = useState(null);
      const timerRef = useRef(null);

      // Efecte de slot machine per a la lletra
      useEffect(() => {
        if (gameState === 'spinning') {
          const interval = setInterval(() => {
            setSpinningLetter(LETTERS[Math.floor(Math.random() * LETTERS.length)]);
          }, 50);

          setTimeout(() => {
            clearInterval(interval);
            const finalLetter = LETTERS[Math.floor(Math.random() * LETTERS.length)];
            setCurrentLetter(finalLetter);
            setSpinningLetter(finalLetter);
            playSound('start');
            setGameState('playing');
            setTimeLeft(GAME_TIME);
          }, 2000);

          return () => clearInterval(interval);
        }
      }, [gameState]);

      // Temporitzador
      useEffect(() => {
        if (gameState === 'playing') {
          timerRef.current = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 1) {
                clearInterval(timerRef.current);
                playSound('end');
                setGameState('finished');
                setTimeout(revealSuggestions, 5000);
                return 0;
              }
              if (prev === 11) {
                playSound('warning');
              }
              return prev - 1;
            });
          }, 1000);
        }

        return () => {
          if (timerRef.current) clearInterval(timerRef.current);
        };
      }, [gameState]);

      const playSound = (type) => {
        try {
            const frequencies = { start: 440, pause: 523, end: 330, warning: 880 };
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            oscillator.frequency.value = frequencies[type];
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.2);
            
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.2);
        } catch (e) {
            console.error("Web Audio API is not supported in this browser.", e);
        }
      };

      const startGame = () => {
        setGameState('spinning');
        setSuggestions(null);
      };

      const pauseGame = () => {
        if (gameState === 'playing') {
          clearInterval(timerRef.current);
          setGameState('paused');
          playSound('pause');
          setTimeout(revealSuggestions, 5000);
        }
      };

      const resetGame = () => {
        if (timerRef.current) clearInterval(timerRef.current);
        setGameState('initial');
        setCurrentLetter('');
        setSpinningLetter('');
        setTimeLeft(GAME_TIME);
        setSuggestions(null);
      };

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const buildSuggestions = () => {
        if (!wordRepository || !currentLetter || !wordRepository[currentLetter]) {
          return null;
        }

        const suggestions = {};
        const letterData = wordRepository[currentLetter];

        for (const category of CATEGORIES) {
            const words = letterData[category.jsonKey] || [];
            const shuffled = [...words].sort(() => 0.5 - Math.random());
            suggestions[category.id] = shuffled.slice(0, 3);
        }
        return suggestions;
      };
      
      const revealSuggestions = () => {
        setSuggestions(buildSuggestions());
      };

      return (
        <div className={`app-container flex flex-col min-h-screen w-full transition-colors duration-300 ${darkMode ? 'bg-gray-900 text-white' : 'bg-gradient-to-br from-purple-100 via-pink-100 to-blue-100 text-gray-800'}`}>
          {/* Cap√ßalera */}
          <header className={`${darkMode ? 'bg-gray-800' : 'bg-white/80 backdrop-blur-sm'} shadow-lg p-4`}>
            <div className="w-full max-w-7xl mx-auto flex justify-between items-center">
              <h1 className="text-4xl md:text-5xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent animate-pulse">
                üé≤ Tutifruti
              </h1>
              <button
                onClick={() => setDarkMode(!darkMode)}
                className={`p-3 rounded-full transition-all hover:scale-110 ${darkMode ? 'bg-yellow-400 text-gray-900' : 'bg-gray-800 text-yellow-400'}`}
              >
                {darkMode ? <Sun size={24} /> : <Moon size={24} />}
              </button>
            </div>
          </header>

          {/* Zona Central */}
          <main className="flex-grow max-w-7xl mx-auto px-4 py-8 w-full flex flex-col">
            {gameState === 'initial' ? (
              <div className="flex-grow flex items-center justify-center">
                <button
                  onClick={startGame}
                  className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-12 py-6 rounded-2xl text-3xl font-bold shadow-2xl hover:shadow-3xl transform hover:scale-105 transition-all flex items-center gap-4 mx-auto"
                >
                  <Play size={40} />
                  Comen√ßa a jugar
                </button>
              </div>
            ) : (
              <>
                {/* Lletra i Temporitzador */}
                <div className="text-center mb-12">
                  {(gameState === 'spinning' || gameState === 'playing' || gameState === 'paused' || gameState === 'finished') && (
                    <div className="flex flex-row items-center justify-center gap-8 md:gap-16">
                      {/* Lletra (Esquerra) */}
                      <div className={`inline-block transition-all duration-500 ${gameState === 'spinning' ? 'scale-90 opacity-70' : 'scale-100'}`}>
                        <div className={`text-9xl md:text-[200px] font-black p-8 rounded-3xl shadow-2xl ${
                          gameState === 'playing' 
                            ? 'bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 animate-pulse' 
                            : darkMode ? 'bg-gray-700' : 'bg-white'
                        }`}>
                          {gameState === 'spinning' ? spinningLetter : currentLetter}
                        </div>
                      </div>

                      {/* Controls (Dreta) */}
                      <div className="flex flex-col items-center space-y-6">
                        {/* Temporitzador */}
                        {(gameState === 'playing' || gameState === 'paused') && (
                          <div className={`text-6xl md:text-7xl font-bold transition-all ${
                            timeLeft <= 10 ? 'text-red-500 animate-pulse scale-110' : darkMode ? 'text-green-400' : 'text-green-600'
                          }`}>
                            ‚è±Ô∏è {formatTime(timeLeft)}
                          </div>
                        )}

                        {/* Botons de control */}
                        <div className="flex flex-col gap-4 justify-center">
                          {gameState === 'playing' && (
                            <button
                              onClick={pauseGame}
                              className="bg-orange-500 text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:bg-orange-600 transition-all flex items-center gap-3"
                            >
                              <Pause size={28} />
                              Tutifruti!
                            </button>
                          )}
                          
                          {suggestions && (
                            <button
                              onClick={resetGame}
                              className="bg-blue-500 text-white px-8 py-4 rounded-xl text-xl font-bold shadow-lg hover:bg-blue-600 transition-all flex items-center gap-3"
                            >
                              <RotateCcw size={28} />
                              Nova Ronda
                            </button>
                          )}
                        </div>

                        {/* Missatges */}
                        {gameState === 'paused' && !suggestions && (
                          <div className="bg-orange-500 text-white p-6 rounded-2xl text-2xl font-bold shadow-2xl animate-bounce w-full">
                            üéâ Tutifruti! Atureu-vos
                          </div>
                        )}

                        {gameState === 'finished' && !suggestions && (
                          <div className="bg-red-500 text-white p-6 rounded-2xl text-2xl font-bold shadow-2xl animate-bounce w-full">
                            ‚è∞ Temps esgotat!
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Categories */}
                {(gameState === 'playing' || gameState === 'paused' || gameState === 'finished') && (
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    {CATEGORIES.map((cat, idx) => (
                      <div
                        key={cat.id}
                        className={`bg-gradient-to-br ${cat.color} p-4 rounded-2xl shadow-xl transform transition-all duration-300 hover:scale-105 flex flex-row items-center justify-between`}
                        style={{ animationDelay: `${idx * 100}ms` }}
                      >
                        <div>
                            <div className="text-5xl md:text-6xl mb-1">{cat.icon}</div>
                            <h3 className="text-xl md:text-2xl font-bold text-white">{cat.name}</h3>
                        </div>
                        {suggestions && suggestions[cat.id] && (
                            <div className="space-y-1 text-right">
                                {suggestions[cat.id].map((word, wordIdx) => (
                                    <div 
                                        key={wordIdx}
                                        className="text-white rounded-md px-2 py-0.5 text-base md:text-lg animate-fadeIn"
                                        style={{ animationDelay: `${(idx * 100) + (wordIdx * 100)}ms` }}
                                    >
                                        {word}
                                    </div>
                                ))}
                            </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </main>
          <footer className={`text-center p-4 text-xs ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            <p>Aplicaci√≥ creada per Felip Sarroca amb l'assist√®ncia de la IA.</p>
            <p>Obra sota llic√®ncia <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ca" target="_blank" rel="noopener noreferrer" className="underline hover:text-yellow-500">CC BY-NC-SA 4.0</a>.</p>
          </footer>
        </div>
      );
    }

    function App() {
        const [wordRepository, setWordRepository] = useState(null);
        const [error, setError] = useState(null);

        useEffect(() => {
            fetch('./assets/tutifruti-cat-dicc.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => setWordRepository(data))
                .catch(error => {
                    console.error('Error fetching word repository:', error);
                    setError(error.message);
                });
        }, []);

        if (error) {
            return <div className="text-red-500 text-center p-8">Error al carregar el diccionari: {error}</div>
        }

        if (!wordRepository) {
            return <div className="text-center p-8">Carregant joc...</div>
        }

        return <TutifrutiGame wordRepository={wordRepository} />;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

  </script>
</body>
</html>
